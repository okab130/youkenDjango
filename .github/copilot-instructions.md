# Python/Django開発 AI駆動ガイドライン

思考は英語で行い、最終的な出力は必ず日本語で提供してください。

## 開発の基本理念
- 業務要件、システム要件から、設計を行う場合、提示要件の不明瞭、曖昧、要件間の矛盾を解消し、データモデル中心のアプローチを行う。
- 進め方は、以下のステップで、行う
    1. 要件・前提条件の読み込み、理解
    2. Djangoモデル設計（models.py）
    3. 機能概要、URLルーティング、ビュー設計、画面一覧
    4. テンプレート設計・モック作成
- 提示要件の不明瞭、曖昧、要件間の矛盾がある状態で進めると、後々大きな手戻りが発生する可能性が高いため、必ず解消する。
- 動くコードを書くだけでなく、品質・保守性・安全性を常に意識する
- プロジェクトの段階（プロトタイプ、MVP、本番環境）に応じて適切なバランスを取る
- 問題を見つけたら放置せず、必ず対処または明示的に記録する
- ボーイスカウトルール：エラーを見つけた時よりも良い状態で残す

## Python/Django固有の原則
- **PEP 8準拠**: Pythonの標準スタイルガイドに従う
- **Djangoのベストプラクティス**: "Fat models, thin views, stupid templates"
- **仮想環境の使用**: 必ずvenv/virtualenvで環境を分離
- **requirements.txt管理**: 依存関係を明確に記録し、バージョンを固定
- **マイグレーション管理**: makemigrations と migrate を適切に実行
- **Django Admin活用**: 管理画面を効果的に使用
- **環境変数**: settings.pyに秘密情報を直接書かない

## エラーハンドリングの原則
- 関連が薄く見えるエラーでも必ず解決する
- エラーの抑制（try-except で握りつぶす等）ではなく、根本原因を修正
- 早期にエラーを検出し、明確なエラーメッセージを提供
- エラーケースも必ずテストでカバーする
- 外部APIやネットワーク通信は必ず失敗する可能性を考慮
- **Python固有**:
  - 具体的な例外をキャッチ（bare except は避ける）
  - カスタム例外クラスを適切に使用
  - ロギングモジュールで適切にログ記録
  - トレースバック情報を保持

## コード品質の基準
- DRY原則：重複を避け、単一の信頼できる情報源を維持
- 意味のある変数名・関数名で意図を明確に伝える
- プロジェクト全体で一貫したコーディングスタイルを維持
- 小さな問題も放置せず、発見次第修正（Broken Windows理論）
- コメントは「なぜ」を説明し、「何を」はコードで表現
- **Python/Django固有**:
  - snake_case for 変数・関数（PEP 8）
  - PascalCase for クラス名
  - UPPER_CASE for 定数
  - Docstrings（Google/NumPy/Sphinx形式）を記述
  - Type hints（Python 3.5+）を活用
  - flake8, pylint, black等のリンター使用
  - Djangoのクエリセット最適化（select_related, prefetch_related）
  - N+1問題の回避

## テスト規律
- テストをスキップせず、問題があれば修正する
- 実装詳細ではなく振る舞いをテスト
- テスト間の依存を避け、任意の順序で実行可能に
- テストは高速で、常に同じ結果を返すように
- カバレッジは指標であり、質の高いテストを重視
- **Python/Django固有**:
  - Django TestCase/TransactionTestCaseを適切に使い分け
  - setUpとtearDownで適切にテストデータを準備・後処理
  - pytest-djangoの活用も検討
  - Factory Boy等のファクトリライブラリでテストデータ生成
  - `python manage.py test` でテスト実行
  - モックは unittest.mock または pytest-mock を使用
  - テストDBは自動的にクリーンアップされる

## 保守性とリファクタリング
- 機能追加と同時に既存コードの改善を検討
- 大規模な変更は小さなステップに分割
- 使用されていないコードは積極的に削除
- 依存関係は定期的に更新（セキュリティと互換性のため）
- 技術的負債は明示的にコメントやドキュメントに記録

## セキュリティの考え方
- APIキー、パスワード等は環境変数で管理（ハードコード禁止）
- すべての外部入力を検証
- 必要最小限の権限で動作（最小権限の原則）
- 不要な依存関係を避ける
- セキュリティ監査ツールを定期的に実行
- **Django固有**:
  - CSRF保護を有効化（デフォルトでON）
  - XSS対策：テンプレートの自動エスケープを活用
  - SQLインジェクション対策：ORMを使用（生SQL避ける）
  - SECRET_KEYは環境変数で管理
  - DEBUG=Falseを本番環境で設定
  - ALLOWED_HOSTSを適切に設定
  - django-environ等で環境変数管理
  - パスワードはmake_password/check_passwordを使用
  - bandit、safety等でセキュリティスキャン

## パフォーマンスの意識
- 推測ではなく計測に基づいて最適化
- 初期段階から拡張性を考慮
- 必要になるまでリソースの読み込みを遅延
- キャッシュの有効期限と無効化戦略を明確に
- N+1問題やオーバーフェッチを避ける
- **Django固有**:
  - select_related（1対1、多対1）でJOIN
  - prefetch_related（多対多、逆参照）で事前取得
  - only/defer で必要なフィールドのみ取得
  - django-debug-toolbarでクエリ数を監視
  - データベースインデックスを適切に設定
  - QuerySetの評価タイミングを理解（遅延評価）
  - キャッシュフレームワークの活用
  - Pillowで画像最適化

## 信頼性の確保
- タイムアウト処理を適切に設定
- リトライ機構の実装（指数バックオフを考慮）
- サーキットブレーカーパターンの活用
- 一時的な障害に対する耐性を持たせる
- 適切なログとメトリクスで可観測性を確保

## プロジェクトコンテキストの理解
- ビジネス要件と技術要件のバランスを取る
- 現在のフェーズで本当に必要な品質レベルを判断
- 時間制約がある場合でも、最低限の品質基準を維持
- チーム全体の技術レベルに合わせた実装選択

## トレードオフの認識
- すべてを完璧にすることは不可能（銀の弾丸は存在しない）
- 制約の中で最適なバランスを見つける
- プロトタイプなら簡潔さを、本番なら堅牢性を優先
- 妥協点とその理由を明確にドキュメント化

## Git運用の基本
- コンベンショナルコミット形式を使用（feat:, fix:, docs:, test:, refactor:, chore:）
- コミットは原子的で、単一の変更に焦点を当てる
- 明確で説明的なコミットメッセージを日本語で記述
- main/masterブランチへの直接コミットは避ける

## コードレビューの姿勢
- レビューコメントは建設的な改善提案として受け取る
- 個人ではなくコードに焦点を当てる
- 変更の理由と影響を明確に説明
- フィードバックを学習機会として歓迎

## デバッグのベストプラクティス
- 問題を確実に再現できる手順を確立
- 二分探索で問題の範囲を絞り込む
- 最近の変更から調査を開始
- デバッガー、プロファイラー等の適切なツールを活用
- 調査結果と解決策を記録し、知識を共有

## 依存関係の管理
- 本当に必要な依存関係のみを追加
- requirements.txtを必ずコミット
- 新しい依存関係追加前にライセンス、サイズ、メンテナンス状況を確認
- セキュリティパッチとバグ修正のため定期的に更新
- **Python固有**:
  - `pip freeze > requirements.txt` で依存関係を記録
  - バージョンを固定（Django==4.2.7）
  - 開発用依存関係はrequirements-dev.txtに分離
  - pip-tools、poetry等のツール活用も検討
  - 仮想環境（venv）を必ず使用
  - `pip install -r requirements.txt` で環境再現
  - safety check でセキュリティ脆弱性チェック

## ドキュメントの基準
- READMEにプロジェクトの概要、セットアップ、使用方法を明確に記載
- ドキュメントをコードと同期して更新
- 実例を示すことを優先
- 重要な設計判断はADR (Architecture Decision Records)で記録
- **Django固有**:
  - モデル、ビュー、URLの関係を明確に文書化
  - マイグレーション手順を記載
  - 初期データ投入方法（management commands）を記録
  - Docstrings（関数・クラスの説明）を充実
  - django-extensionsの show_urls等を活用

## Django開発のベストプラクティス
- **プロジェクト構成**:
  - settings.pyを環境別に分割（base.py, dev.py, prod.py）
  - アプリは単一責任の原則で分割
  - templatesとstaticは適切に配置
- **モデル設計**:
  - __str__メソッドを必ず定義
  - Meta classでorderingやverbose_nameを設定
  - プロパティで計算フィールドを実装
  - clean()メソッドでバリデーション
- **ビュー設計**:
  - クラスベースビュー（CBV）の活用
  - デコレーターで認証・権限チェック
  - トランザクション管理（@transaction.atomic）
- **URLルーティング**:
  - app_nameで名前空間を定義
  - reverse()やurl templateタグで動的URL生成
  - path()とre_path()を使い分け
- **テンプレート**:
  - ロジックはテンプレートに書かない
  - カスタムテンプレートタグ/フィルター活用
  - {% csrf_token %}を忘れない
- **フォーム**:
  - ModelFormを活用
  - clean_<fieldname>でフィールド別検証
  - clean()でフォーム全体の検証

## 継続的な改善
- 学んだことを次のプロジェクトに活かす
- 定期的に振り返りを行い、プロセスを改善
- 新しいツールや手法を適切に評価して取り入れる
- チームや将来の開発者のために知識を文書化
- **Django固有**:
  - Djangoの最新バージョン情報をチェック
  - Django公式ドキュメントを第一の情報源とする
  - Django Packagesで有用なサードパーティパッケージを探す
